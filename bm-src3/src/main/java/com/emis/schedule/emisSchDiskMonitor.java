package com.emis.schedule;import com.emis.qa.emisServletContext;import com.emis.server.emisServerFactory;import com.emis.mail.emisMailer;import com.emis.schedule.emisTask;import javax.servlet.ServletContext;import java.io.InputStream;import java.io.File;import java.io.FileInputStream;import java.util.*;/** * Created by IntelliJ IDEA. * User: Administrator * Date: Apr 19, 2004 * Time: 10:46:33 AM * To change this template use Options | File Templates. */public class emisSchDiskMonitor extends emisTask{    String _sConfigName; // c:\resin\***.cfig    public emisSchDiskMonitor(){    } public emisSchDiskMonitor(ServletContext oContext){         setContext(oContext);    }  public void runTask() throws Exception {          try{          System.out.println("run mail start");            Monitor();                       System.out.println("run mail endstart");          }catch(Exception e){             //e.printStackTrace();          }    }    /**     *     * @param Path  專案的cfg 檔案     * @param nfProperty  cfg 檔案的 Properties     * @return     */    public String getMailContent(String Path,Properties nfProperty){        //System.out.println(Path);        String [] oConfig = split(Path,"\\"); // oConfig[0] = c: oConfig[1] = resin oConfig[2] = 專案.cfg        String sPrjName = oConfig[2].substring(0,oConfig[2].indexOf("."));        String sWwwLogPath = oConfig[0]+"\\wwwroot\\"+sPrjName+"\\logs";        String sResinLogPath = oConfig[0]+"\\resin\\log";        emisSchDiskSpaceHelp emisSchDiskSpaceHelp = new emisSchDiskSpaceHelp();        String Db ="資料庫硬碟尚有"+ emisSchDiskSpaceHelp.getDbFreeSpace(nfProperty.getProperty("emis.db.drive"));        String WWWROOTLog = "WWWROOT 的log file佔有  "+emisSchDiskSpaceHelp.getLogFileSize(sWwwLogPath);        String ResinLog = "Resin 的log file佔有  "+emisSchDiskSpaceHelp.getLogFileSize(sResinLogPath);        String resinLogBackupOK = "Resin log 備份於"+nfProperty.getProperty("emis.log.backup.destination")+                                   emisSchDiskSpaceHelp.jarFile("resin",nfProperty.getProperty("emis.log.backup.destination"),sResinLogPath,true);        String WwwrootLogBackupOK = "WWWROOT log 備份於"+nfProperty.getProperty("emis.log.backup.destination")+                                    emisSchDiskSpaceHelp.jarFile("wwwroot",nfProperty.getProperty("emis.log.backup.destination"),sWwwLogPath,true);;        return Db+ WWWROOTLog+ResinLog+resinLogBackupOK+WwwrootLogBackupOK;    }    /**     * 主要執行程式     * @throws Exception     */    public void Monitor()throws Exception{        // 注意  如果用mail 執行 ,下面這行須註解          _sConfigName = oContext_.getInitParameter("emiscfg");           emisMailer m= null;           Properties nfProperty = new Properties() ;           File  oFile = new File(_sConfigName);           InputStream io =  null;        try{                io =  new FileInputStream(oFile);                nfProperty.load(io);            String content = getMailContent(_sConfigName,nfProperty);            String [] MailAddress= split(nfProperty.getProperty("system.mail.smtp.address"),";");            for(int i =0; i < MailAddress.length ;i++){                m = new emisMailer ();                m.setFrom ("EMIS","Administrator");                m.setTo (MailAddress[i]);                m.setSubject ("系統通知");                m.setContent (content);                m.send(oContext_);            }        }catch(Exception e){            e.printStackTrace();        }finally{            nfProperty.clear();            io.close();        }    }    /**     *     * @param strContent 須分割的字串     * @param region   判斷分割的字元     * @return     */    public String[] split(String strContent, String region) {        List list = new ArrayList();        StringTokenizer oProjectToken = new StringTokenizer(strContent, region);            while (oProjectToken.hasMoreTokens()) {                  list.add(oProjectToken.nextToken());            }        return (String[]) list.toArray(new String[]{});      }    public static void main(String[] args){        try{                 //  emisUtil.compressAll();                   emisServletContext servlet = new emisServletContext();                   emisServerFactory.createServer(servlet, "c:\\wwwroot\\ylib", "c:\\resin\\ylib.cfg", true);                   emisSchDiskMonitor s =new emisSchDiskMonitor();                   s._sConfigName="c:\\resin\\ylib.cfg";                 //  s.jarFile("resin","c:\\temp","c:\\resin\\log",true);                   s.run();            System.out.println("OK----");        }catch(Exception e){e.printStackTrace();}    }}